<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Exam - <%= exam.title %>
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .question-card {
            border-left: 4px solid #007bff;
            margin-bottom: 20px;
        }

        .student-answer {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }

        .correct-answer {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .incorrect-answer {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>

<body>
    <%- include('../partials/navbar') %>

        <div class="container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>Grade Exam: <%= exam.title %>
                    </h2>
                    <p class="text-muted mb-0">
                        Student: <%= attempt.student.user.firstName %>
                            <%= attempt.student.user.lastName %>
                    </p>
                    <p class="text-muted">
                        Submitted: <%= attempt.submittedAt ? new Date(attempt.submittedAt).toLocaleString()
                            : 'Not submitted' %>
                    </p>
                </div>
                <div>
                    <a href="/teacher/exam/<%= exam.id %>/results" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Results
                    </a>
                </div>
            </div>

            <form id="gradingForm">
                <input type="hidden" name="attemptId" value="<%= attempt.id %>">

                <div class="row">
                    <div class="col-md-8">
                        <!-- Questions and Answers -->
                        <% if (exam.questions && exam.questions.length> 0) { %>
                            <% exam.questions.forEach((question, index)=> { %>
                                <div class="card question-card mb-3">
                                    <div class="card-header">
                                        <h5 class="mb-0">Question <%= index + 1 %>
                                        </h5>
                                        <small class="text-muted">
                                            <%= question.marks || 1 %> marks
                                        </small>
                                    </div>
                                    <div class="card-body">
                                        <p>
                                            <%= question.question %>
                                        </p>

                                        <!-- Student's Answer -->
                                        <div class="student-answer">
                                            <strong>Student's Answer:</strong>
                                            <% const studentAnswer=attempt.answers && attempt.answers[index]
                                                !==undefined ? attempt.answers[index] : 'No answer provided' ; %>
                                                <p class="mb-2">
                                                    <%= studentAnswer %>
                                                </p>

                                                <!-- Grading Input -->
                                                <div class="grading-section mt-3">
                                                    <label class="form-label"><strong>Assign Marks:</strong></label>
                                                    <input type="number" class="form-control"
                                                        name="scores[<%= index %>]" min="0"
                                                        max="<%= question.marks || 1 %>" step="0.5"
                                                        value="<%= question.marks || 1 %>" style="width: 120px;">
                                                </div>
                                        </div>
                                    </div>
                                </div>
                                <% }); %>
                                    <% } else { %>
                                        <div class="alert alert-warning">
                                            No questions found for this exam.
                                        </div>
                                        <% } %>
                    </div>

                    <div class="col-md-4">
                        <!-- Grading Summary -->
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Grading Summary</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="totalScore" class="form-label"><strong>Total Score</strong></label>
                                    <input type="number" class="form-control" id="totalScore" name="totalScore" min="0"
                                        max="<%= exam.totalMarks || 100 %>" step="0.5" value="0">
                                </div>

                                <div class="mb-3">
                                    <label for="feedback" class="form-label"><strong>Teacher Feedback</strong></label>
                                    <textarea class="form-control" id="feedback" name="feedback" rows="4"
                                        placeholder="Provide feedback to the student..."></textarea>
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-check"></i> Submit Grading
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="calculateTotal()">
                                        <i class="fas fa-calculator"></i> Calculate Total
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <script>
            function calculateTotal() {
                let total = 0;
                const scoreInputs = document.querySelectorAll('input[name^="scores["]');

                scoreInputs.forEach(input => {
                    total += parseFloat(input.value) || 0;
                });

                document.getElementById('totalScore').value = total.toFixed(1);
            }

            // Auto-calculate when score inputs change
            document.addEventListener('DOMContentLoaded', function () {
                const scoreInputs = document.querySelectorAll('input[name^="scores["]');
                scoreInputs.forEach(input => {
                    input.addEventListener('change', calculateTotal);
                });

                // Calculate initial total
                calculateTotal();
            });

            // Handle form submission
            document.getElementById('gradingForm').addEventListener('submit', function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const data = {
                    scores: {},
                    totalScore: parseFloat(formData.get('totalScore')),
                    feedback: formData.get('feedback')
                };

                // Collect all scores
                formData.forEach((value, key) => {
                    if (key.startsWith('scores[')) {
                        const match = key.match(/scores\[(\d+)\]/);
                        if (match) {
                            data.scores[match[1]] = parseFloat(value);
                        }
                    }
                });

                fetch('/teacher/api/exams/attempts/<%= attempt.id %>/grade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert('Exam graded successfully!');
                            window.location.href = '/teacher/exam/<%= exam.id %>/results';
                        } else {
                            alert('Error: ' + result.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error submitting grading. Please try again.');
                    });
            });
        </script>
</body>

</html>