<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdTech - Grading</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            border: none;
        }

        .submission-item {
            border-left: 4px solid #007bff;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .submission-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .submission-item.graded {
            border-left-color: #28a745;
        }

        .submission-item.pending {
            border-left-color: #ffc107;
        }

        .empty-state {
            padding: 3rem 1rem;
            text-align: center;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .btn-action {
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-action:hover {
            transform: translateY(-2px);
        }

        .submission-type-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
        }
    </style>
</head>

<body>
    <%- include('../partials/navbar') %>

        <div class="container mt-4">
            <%- include('../partials/alerts') %>

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-check-circle me-2"></i>Submission Grading</h2>
                    <div class="btn-group">
                        <a href="/teacher/grading" class="btn btn-outline-primary">All Submissions</a>
                        <a href="/teacher/grading?status=pending" class="btn btn-outline-warning">Pending Grading</a>
                        <a href="/teacher/grading?status=graded" class="btn btn-outline-success">Graded</a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-list me-2"></i>Submissions to Grade</h4>
                    </div>
                    <div class="card-body">
                        <% if (submissions && submissions.length> 0) { %>
                            <div class="list-group">
                                <% submissions.forEach(submission=> {
                                    // Determine submission type and content
                                    const submissionType = submission.submissionType || (submission.fileUrl ? 'file' :
                                    'unknown');
                                    const hasFile = submission.fileUrl && submission.fileUrl !== null;
                                    const hasContent = submission.content && submission.content !== null;
                                    const hasDrawing = submission.drawingData && submission.drawingData !== null;
                                    %>
                                    <div
                                        class="list-group-item submission-item <%= submission.grade !== null ? 'graded' : 'pending' %>">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center mb-2">
                                                    <h6 class="mb-0 me-2">
                                                        <%= submission.assignment.title %>
                                                    </h6>
                                                    <span class="badge submission-type-badge bg-secondary">
                                                        <i class="fas fa-<%= 
                                                            submissionType === 'text' ? 'keyboard' : 
                                                            submissionType === 'drawing' ? 'paint-brush' : 
                                                            'file' 
                                                        %> me-1"></i>
                                                        <%= submissionType.toUpperCase() %>
                                                    </span>
                                                    <% if (submission.textTitle) { %>
                                                        <span class="badge submission-type-badge bg-info ms-1">
                                                            <%= submission.textTitle %>
                                                        </span>
                                                        <% } %>
                                                </div>
                                                <p class="mb-1">
                                                    <strong>Student:</strong>
                                                    <%= submission.student.user.firstName %>
                                                        <%= submission.student.user.lastName %>
                                                            (<%= submission.student.user.idNumber %>)
                                                </p>
                                                <p class="mb-1">
                                                    <strong>Class:</strong>
                                                    <span class="badge bg-primary">
                                                        <%= submission.assignment.class['name'] %>
                                                    </span>
                                                </p>
                                                <p class="mb-1 text-muted">
                                                    <strong>Submitted:</strong>
                                                    <%= new Date(submission.submittedAt).toLocaleString() %>
                                                </p>
                                                <% if (submission.grade !==null) { %>
                                                    <p class="mb-0">
                                                        <strong>Grade:</strong>
                                                        <span
                                                            class="badge bg-<%= submission.grade >= 80 ? 'success' : submission.grade >= 60 ? 'warning' : 'danger' %>">
                                                            <%= submission.grade %>/100
                                                        </span>
                                                    </p>
                                                    <% } %>
                                            </div>
                                            <div class="btn-group">
                                                <!-- FIXED: Only show download button if fileUrl exists -->
                                                <% if (hasFile) { %>
                                                    <a href="/uploads/<%= submission.fileUrl.split('/').pop() %>"
                                                        class="btn btn-sm btn-outline-primary btn-action" download>
                                                        <i class="fas fa-download"></i> Download
                                                    </a>
                                                    <% } %>

                                                        <!-- Show view content button for text submissions -->
                                                        <% if (hasContent && !hasFile) { %>
                                                            <button class="btn btn-sm btn-outline-info btn-action"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#viewContentModal<%= submission.id %>">
                                                                <i class="fas fa-eye"></i> View Content
                                                            </button>
                                                            <% } %>

                                                                <!-- Show view drawing button for drawing submissions -->
                                                                <% if (hasDrawing && !hasFile) { %>
                                                                    <button
                                                                        class="btn btn-sm btn-outline-success btn-action"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#viewDrawingModal<%= submission.id %>">
                                                                        <i class="fas fa-paint-brush"></i> View Drawing
                                                                    </button>
                                                                    <% } %>

                                                                        <% if (submission.grade===null) { %>
                                                                            <button
                                                                                class="btn btn-sm btn-outline-warning btn-action"
                                                                                data-bs-toggle="modal"
                                                                                data-bs-target="#gradeModal<%= submission.id %>">
                                                                                <i class="fas fa-edit"></i> Grade
                                                                            </button>
                                                                            <% } else { %>
                                                                                <button
                                                                                    class="btn btn-sm btn-outline-info btn-action"
                                                                                    data-bs-toggle="modal"
                                                                                    data-bs-target="#viewGradeModal<%= submission.id %>">
                                                                                    <i class="fas fa-eye"></i> View
                                                                                </button>
                                                                                <% } %>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- View Content Modal for text submissions -->
                                    <% if (hasContent && !hasFile) { %>
                                        <div class="modal fade" id="viewContentModal<%= submission.id %>" tabindex="-1">
                                            <div class="modal-dialog modal-lg">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">
                                                            <i class="fas fa-keyboard me-2"></i>
                                                            Text Submission: <%= submission.textTitle ||
                                                                submission.assignment.title %>
                                                        </h5>
                                                        <button type="button" class="btn-close"
                                                            data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="alert alert-info">
                                                            <p class="mb-1"><strong>Student:</strong>
                                                                <%= submission.student.user.firstName %>
                                                                    <%= submission.student.user.lastName %>
                                                            </p>
                                                            <p class="mb-0"><strong>Submitted:</strong>
                                                                <%= new Date(submission.submittedAt).toLocaleString() %>
                                                            </p>
                                                        </div>
                                                        <div class="submission-content border rounded p-3 bg-light">
                                                            <%- submission.content %>
                                                        </div>
                                                        <% if (submission.wordCount) { %>
                                                            <div class="mt-2 text-muted">
                                                                <small>Word Count: <%= submission.wordCount %></small>
                                                            </div>
                                                            <% } %>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary"
                                                            data-bs-dismiss="modal">Close</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <% } %>

                                            <!-- View Drawing Modal for drawing submissions -->
                                            <% if (hasDrawing && !hasFile) { %>
                                                <div class="modal fade" id="viewDrawingModal<%= submission.id %>"
                                                    tabindex="-1">
                                                    <div class="modal-dialog modal-lg">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title">
                                                                    <i class="fas fa-paint-brush me-2"></i>
                                                                    Drawing Submission: <%= submission.textTitle ||
                                                                        submission.assignment.title %>
                                                                </h5>
                                                                <button type="button" class="btn-close"
                                                                    data-bs-dismiss="modal"></button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <div class="alert alert-info">
                                                                    <p class="mb-1"><strong>Student:</strong>
                                                                        <%= submission.student.user.firstName %>
                                                                            <%= submission.student.user.lastName %>
                                                                    </p>
                                                                    <p class="mb-0"><strong>Submitted:</strong>
                                                                        <%= new
                                                                            Date(submission.submittedAt).toLocaleString()
                                                                            %>
                                                                    </p>
                                                                </div>
                                                                <div class="text-center">
                                                                    <img src="<%= submission.drawingData %>"
                                                                        alt="Student Drawing"
                                                                        class="img-fluid rounded border"
                                                                        style="max-height: 500px;">
                                                                </div>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary"
                                                                    data-bs-dismiss="modal">Close</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <% } %>

                                                    <!-- Grade Modal for each submission -->
                                                    <div class="modal fade" id="gradeModal<%= submission.id %>"
                                                        tabindex="-1">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title">Grade Submission</h5>
                                                                    <button type="button" class="btn-close"
                                                                        data-bs-dismiss="modal"></button>
                                                                </div>
                                                                <form action="/teacher/grading/<%= submission.id %>"
                                                                    method="POST">
                                                                    <div class="modal-body">
                                                                        <p><strong>Assignment:</strong>
                                                                            <%= submission.assignment.title %>
                                                                        </p>
                                                                        <p><strong>Student:</strong>
                                                                            <%= submission.student.user.firstName %>
                                                                                <%= submission.student.user.lastName %>
                                                                        </p>
                                                                        <p><strong>Class:</strong>
                                                                            <%= submission.assignment.class['name'] %>
                                                                        </p>
                                                                        <p><strong>Submission Type:</strong>
                                                                            <span class="badge bg-secondary">
                                                                                <%= submissionType.toUpperCase() %>
                                                                            </span>
                                                                        </p>

                                                                        <div class="mb-3">
                                                                            <label class="form-label">Grade (0-100)
                                                                                *</label>
                                                                            <input type="number" class="form-control"
                                                                                name="grade" min="0" max="100"
                                                                                step="0.1" required>
                                                                        </div>
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Feedback</label>
                                                                            <textarea class="form-control"
                                                                                name="feedback" rows="3"
                                                                                placeholder="Provide constructive feedback..."></textarea>
                                                                        </div>
                                                                    </div>
                                                                    <div class="modal-footer">
                                                                        <button type="button" class="btn btn-secondary"
                                                                            data-bs-dismiss="modal">Cancel</button>
                                                                        <button type="submit"
                                                                            class="btn btn-primary">Submit
                                                                            Grade</button>
                                                                    </div>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- View Grade Modal for each submission -->
                                                    <div class="modal fade" id="viewGradeModal<%= submission.id %>"
                                                        tabindex="-1">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title">Submission Details</h5>
                                                                    <button type="button" class="btn-close"
                                                                        data-bs-dismiss="modal"></button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <p><strong>Assignment:</strong>
                                                                        <%= submission.assignment.title %>
                                                                    </p>
                                                                    <p><strong>Student:</strong>
                                                                        <%= submission.student.user.firstName %>
                                                                            <%= submission.student.user.lastName %>
                                                                    </p>
                                                                    <p><strong>Class:</strong>
                                                                        <%= submission.assignment.class['name'] %>
                                                                    </p>
                                                                    <p><strong>Submission Type:</strong>
                                                                        <span class="badge bg-secondary">
                                                                            <%= submissionType.toUpperCase() %>
                                                                        </span>
                                                                    </p>
                                                                    <p><strong>Submitted:</strong>
                                                                        <%= new
                                                                            Date(submission.submittedAt).toLocaleString()
                                                                            %>
                                                                    </p>
                                                                    <p><strong>Grade:</strong>
                                                                        <span
                                                                            class="badge bg-<%= submission.grade >= 80 ? 'success' : submission.grade >= 60 ? 'warning' : 'danger' %>">
                                                                            <%= submission.grade %>/100
                                                                        </span>
                                                                    </p>
                                                                    <% if (submission.feedback) { %>
                                                                        <div class="mt-3">
                                                                            <strong>Feedback:</strong>
                                                                            <div class="alert alert-light border mt-2">
                                                                                <%= submission.feedback %>
                                                                            </div>
                                                                        </div>
                                                                        <% } %>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-secondary"
                                                                        data-bs-dismiss="modal">Close</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <% }); %>
                            </div>
                            <% } else { %>
                                <div class="empty-state">
                                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                    <h5>All caught up!</h5>
                                    <p class="text-muted">No submissions pending grading at the moment.</p>
                                </div>
                                <% } %>
                    </div>
                </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>