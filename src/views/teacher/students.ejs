<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %> - EdTech
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .card-stat {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            border-radius: 10px;
        }

        .card-stat:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .student-table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .student-table th {
            background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            padding: 12px 15px;
        }

        .student-table td {
            padding: 12px 15px;
            vertical-align: middle;
        }

        .action-buttons .btn {
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 0.85rem;
        }

        .empty-state {
            padding: 3rem 1rem;
            text-align: center;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .class-card {
            transition: transform 0.3s ease;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            height: 100%;
        }

        .class-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .print-hidden {
            display: block;
        }

        @media print {
            .print-hidden {
                display: none !important;
            }

            .btn {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <%- include('../partials/navbar') %>

        <div class="container mt-4">
            <%- include('../partials/alerts') %>

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-users me-2"></i> Student Management</h2>
                    <div class="btn-group print-hidden">
                        <button class="btn btn-outline-primary" onclick="window.print()">
                            <i class="fas fa-print me-1"></i> Print Report
                        </button>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-4 mb-3">
                        <div class="card text-white bg-primary card-stat">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h5 class="card-title mb-0">
                                            <%= students.length %>
                                        </h5>
                                        <p class="card-text mb-0">Total Students</p>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-users fa-2x opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card text-white bg-success card-stat">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h5 class="card-title mb-0">
                                            <%= classes.length %>
                                        </h5>
                                        <p class="card-text mb-0">Your Classes</p>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-chalkboard fa-2x opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card text-white bg-info card-stat">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h5 class="card-title mb-0">
                                            <%= assignmentsCount %>
                                        </h5>
                                        <p class="card-text mb-0">Total Assignments</p>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-tasks fa-2x opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search and Filter Section -->
                <div class="card mb-4 print-hidden">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" id="searchInput" class="form-control"
                                        placeholder="Search students by name, ID, or email..."
                                        onkeyup="searchStudents()">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="classFilter" onchange="filterByClass()">
                                    <option value="">All Classes</option>
                                    <% classes.forEach(function(cls) { %>
                                        <option value="<%= cls.id %>">
                                            <%= cls.name %>
                                        </option>
                                        <% }); %>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students Table -->
                <div class="card student-table">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>All Students</h5>
                    </div>
                    <div class="card-body p-0">
                        <% if (students && students.length> 0) { %>
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="studentsTable">
                                    <thead>
                                        <tr>
                                            <th>ID Number</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Classes</th>
                                            <th>Status</th>
                                            <th class="print-hidden">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% students.forEach(function(student) { %>
                                            <tr
                                                data-classes="<%= student.enrollments ? student.enrollments.map(e => e.classId).join(',') : '' %>">
                                                <td class="fw-bold">
                                                    <%= student.user.idNumber %>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <% if (student.user.avatar) { %>
                                                            <img src="<%= student.user.avatar %>" alt="Profile"
                                                                class="rounded-circle me-2"
                                                                style="width: 32px; height: 32px; object-fit: cover;"
                                                                onerror="this.style.display='none'">
                                                            <% } %>
                                                                <div>
                                                                    <%= student.user.firstName %>
                                                                        <%= student.user.lastName %>
                                                                </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <%= student.user.email || 'N/A' %>
                                                </td>
                                                <td>
                                                    <% if (student.enrollments && student.enrollments.length> 0) { %>
                                                        <div class="d-flex flex-wrap gap-1">
                                                            <% student.enrollments.forEach(function(enrollment) { %>
                                                                <span class="badge bg-primary">
                                                                    <% const cls=classes.find(c=>
                                                                        c.id===enrollment.classId); %>
                                                                        <%= cls ? cls.name : 'Class ' +
                                                                            enrollment.classId %>
                                                                </span>
                                                                <% }); %>
                                                        </div>
                                                        <% } else { %>
                                                            <span class="badge bg-secondary">No classes</span>
                                                            <% } %>
                                                </td>
                                                <td>
                                                    <span
                                                        class="badge bg-<%= student.user.isActive ? 'success' : 'secondary' %>">
                                                        <%= student.user.isActive ? 'Active' : 'Inactive' %>
                                                    </span>
                                                </td>
                                                <td class="action-buttons print-hidden">
                                                    <% if (student.enrollments && student.enrollments.length> 0) { %>
                                                        <% const firstClass=student.enrollments[0].classId; %>
                                                            <a href="/teacher/class/<%= firstClass %>?student=<%= student.id %>"
                                                                class="btn btn-sm btn-primary">
                                                                <i class="fas fa-eye me-1"></i> View Class
                                                            </a>
                                                            <% } else { %>
                                                                <span class="btn btn-sm btn-outline-secondary disabled">
                                                                    <i class="fas fa-eye me-1"></i> No Classes
                                                                </span>
                                                                <% } %>
                                                </td>
                                            </tr>
                                            <% }); %>
                                    </tbody>
                                </table>
                            </div>
                            <% } else { %>
                                <div class="empty-state">
                                    <i class="fas fa-user-graduate"></i>
                                    <h4>No Students Found</h4>
                                    <p class="text-muted">Students will appear here once they enroll in your classes.
                                    </p>
                                    <a href="/teacher/classes" class="btn btn-primary mt-2">
                                        <i class="fas fa-chalkboard me-1"></i> View Your Classes
                                    </a>
                                </div>
                                <% } %>
                    </div>
                </div>

                <!-- Classes Summary -->
                <% if (classes && classes.length> 0) { %>
                    <div class="card mt-4">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="fas fa-chalkboard me-2"></i>Your Classes Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <% classes.forEach(function(cls) { %>
                                    <div class="col-md-4 mb-3">
                                        <div class="card class-card">
                                            <div class="card-body">
                                                <h6
                                                    class="card-title d-flex justify-content-between align-items-center">
                                                    <span>
                                                        <%= cls.name %>
                                                    </span>
                                                    <span class="badge bg-primary">
                                                        <%= cls.enrollments ? cls.enrollments.length : 0 %> students
                                                    </span>
                                                </h6>
                                                <p class="card-text text-muted small mb-2">
                                                    <%= cls.grade %> - <%= cls.section %>
                                                </p>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="text-muted small">
                                                        <%= cls.assignments ? cls.assignments.length : 0 %> assignments
                                                    </span>
                                                    <a href="/teacher/class/<%= cls.id %>"
                                                        class="btn btn-sm btn-outline-primary">
                                                        View Class
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <% }); %>
                            </div>
                        </div>
                    </div>
                    <% } %>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Search functionality
            function searchStudents() {
                const input = document.getElementById('searchInput');
                const filter = input.value.toLowerCase();
                const table = document.getElementById('studentsTable');
                const rows = table.getElementsByTagName('tr');

                // Skip the header row
                for (let i = 1; i < rows.length; i++) {
                    const cells = rows[i].getElementsByTagName('td');
                    let found = false;

                    for (let j = 0; j < cells.length; j++) {
                        const cellText = cells[j].textContent || cells[j].innerText;
                        if (cellText.toLowerCase().includes(filter)) {
                            found = true;
                            break;
                        }
                    }

                    rows[i].style.display = found ? '' : 'none';
                }
            }

            // Filter by class functionality
            function filterByClass() {
                const classFilter = document.getElementById('classFilter');
                const selectedClassId = classFilter.value;
                const table = document.getElementById('studentsTable');
                const rows = table.getElementsByTagName('tr');

                // Skip the header row
                for (let i = 1; i < rows.length; i++) {
                    if (!selectedClassId) {
                        // Show all rows if no filter is selected
                        rows[i].style.display = '';
                        continue;
                    }

                    const classList = rows[i].getAttribute('data-classes');
                    if (classList && classList.includes(selectedClassId)) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            }

            // Initialize page
            document.addEventListener('DOMContentLoaded', function () {
                console.log('Student management page loaded');

                // Add event listener for print button
                document.querySelector('.btn-print').addEventListener('click', function () {
                    window.print();
                });
            });
        </script>
</body>

</html>