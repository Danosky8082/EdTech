<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdTech - Analytics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stat-card {
            transition: transform 0.2s;
            border-left: 4px solid;
            border-radius: 8px;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-card.students {
            border-left-color: #4e73df;
        }

        .stat-card.teachers {
            border-left-color: #1cc88a;
        }

        .stat-card.classes {
            border-left-color: #36b9cc;
        }

        .stat-card.assignments {
            border-left-color: #f6c23e;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 2rem;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .icon-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

<%- include('../partials/navbar') %>

    <div class="container mt-4">
        <%- include('../partials/alerts') %>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Analytics Dashboard</h2>
            <div class="btn-group">
                <button class="btn btn-outline-primary" onclick="exportData('json')">Export JSON</button>
                <button class="btn btn-outline-success" onclick="exportData('csv')">Export CSV</button>
                <button class="btn btn-outline-info" onclick="refreshData()">Refresh Data</button>
            </div>
        </div>

        <!-- Overview Statistics -->
        <div class="row mb-4" id="overviewStats">
            <!-- This will be populated by JavaScript -->
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">User Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="userDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Grade Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="gradeDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Statistics -->
        <div class="row mb-4" id="activityStats">
            <!-- This will be populated by JavaScript -->
        </div>

        <!-- Recent Activity -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Recent System Activity</h5>
            </div>
            <div class="card-body">
                <div id="recentActivityContent">
                    <!-- This will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables to store chart instances
        let userDistributionChartInstance = null;
        let gradeDistributionChartInstance = null;

        // Function to fetch data from your backend API
        async function fetchData() {
            try {
                // Show loading overlay
                document.getElementById('loadingOverlay').style.display = 'flex';

                // Fetch data from your backend API endpoints
                const [overviewData, gradesData, activitiesData] = await Promise.all([
                    fetchOverviewData(),
                    fetchGradesData(),
                    fetchActivitiesData()
                ]);

                // Process and display the data
                renderOverviewStats(overviewData);
                renderActivityStats(overviewData);
                renderRecentActivities(activitiesData);
                renderCharts(overviewData, gradesData);

                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';

            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Error loading data. Please try again.');
            }
        }

        // API functions to fetch data from your backend
        async function fetchOverviewData() {
            try {
                const response = await fetch('/admin/analytics-data');
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error('Error fetching overview data:', error);
                throw error;
            }
        }

        async function fetchGradesData() {
            try {
                const response = await fetch('/admin/grades-data');
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error('Error fetching grades data:', error);
                throw error;
            }
        }

        async function fetchActivitiesData() {
            try {
                const response = await fetch('/admin/activities-data');
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error('Error fetching activities data:', error);
                throw error;
            }
        }

        // Function to render overview statistics
        function renderOverviewStats(data) {
            const overviewStatsElement = document.getElementById('overviewStats');

            overviewStatsElement.innerHTML = `
                <div class="col-md-3 mb-3">
                    <div class="card stat-card students">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title text-muted">Total Students</h6>
                                    <h3 class="card-value">${data.totalStudents}</h3>
                                </div>
                                <div class="icon-circle bg-primary text-white">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <p class="text-muted mt-2 mb-0">+2 from last month</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card teachers">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title text-muted">Teachers</h6>
                                    <h3 class="card-value">${data.totalTeachers}</h3>
                                </div>
                                <div class="icon-circle bg-success text-white">
                                    <i class="fas fa-chalkboard-teacher"></i>
                                </div>
                            </div>
                            <p class="text-muted mt-2 mb-0">+2 from last quarter</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card classes">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title text-muted">Classes</h6>
                                    <h3 class="card-value">${data.totalClasses}</h3>
                                </div>
                                <div class="icon-circle bg-info text-white">
                                    <i class="fas fa-chalkboard"></i>
                                </div>
                            </div>
                            <p class="text-muted mt-2 mb-0">Active this term</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card assignments">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title text-muted">Assignments</h6>
                                    <h3 class="card-value">${data.totalAssignments}</h3>
                                </div>
                                <div class="icon-circle bg-warning text-white">
                                    <i class="fas fa-tasks"></i>
                                </div>
                            </div>
                            <p class="text-muted mt-2 mb-0">Created this month</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Function to render activity statistics
        function renderActivityStats(data) {
            const activityStatsElement = document.getElementById('activityStats');

            activityStatsElement.innerHTML = `
                <div class="col-md-4 mb-3">
                    <div class="card stat-card text-center bg-secondary text-white">
                        <div class="card-body">
                            <i class="fas fa-file-upload fa-2x mb-2"></i>
                            <h3>${data.recentMaterials}</h3>
                            <p class="mb-0">Materials (30 days)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card stat-card text-center bg-danger text-white">
                        <div class="card-body">
                            <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                            <h3>${data.recentAssignments}</h3>
                            <p class="mb-0">Assignments (30 days)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card stat-card text-center bg-dark text-white">
                        <div class="card-body">
                            <i class="fas fa-file-alt fa-2x mb-2"></i>
                            <h3>${data.recentSubmissions}</h3>
                            <p class="mb-0">Submissions (30 days)</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Function to render recent activities
        function renderRecentActivities(activities) {
            const recentActivityContent = document.getElementById('recentActivityContent');

            if (activities && activities.length > 0) {
                let activitiesHTML = `
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Activity</th>
                                    <th>Timestamp</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                activities.forEach(activity => {
                    // Determine activity description based on type
                    let activityDescription = "Account Created";
                    let activityDetails = `New ${activity.role} account registration`;

                    if (activity.activityType === "assignment_created") {
                        activityDescription = "Assignment Created";
                        activityDetails = "Created a new assignment";
                    } else if (activity.activityType === "submission") {
                        activityDescription = "Assignment Submitted";
                        activityDetails = "Submitted an assignment";
                    } else if (activity.activityType === "login") {
                        activityDescription = "User Login";
                        activityDetails = "Logged into the system";
                    } else if (activity.activityType === "system_update") {
                        activityDescription = "System Update";
                        activityDetails = "Performed system maintenance";
                    }

                    activitiesHTML += `
                        <tr>
                            <td>
                                <strong>${activity.firstName} ${activity.lastName}</strong>
                                <br>
                                <small class="text-muted">${activity.idNumber}</small>
                            </td>
                            <td>
                                <span class="badge bg-${activity.role === 'admin' ? 'danger' :
                            activity.role === 'teacher' ? 'warning' : 'info'
                        }">
                                    ${activity.role}
                                </span>
                            </td>
                            <td>${activityDescription}</td>
                            <td>${new Date(activity.createdAt).toLocaleString()}</td>
                            <td>${activityDetails}</td>
                        </tr>
                    `;
                });

                activitiesHTML += `
                            </tbody>
                        </table>
                    </div>
                `;

                recentActivityContent.innerHTML = activitiesHTML;
            } else {
                recentActivityContent.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <h5>No activity data available</h5>
                        <p class="text-muted">Activity data will appear here as users interact with the system.</p>
                    </div>
                `;
            }
        }

        // Function to render charts
        function renderCharts(overviewData, gradesData) {
            // User Distribution Chart
            const userCtx = document.getElementById('userDistributionChart').getContext('2d');

            // Destroy previous chart instance if it exists
            if (userDistributionChartInstance) {
                userDistributionChartInstance.destroy();
            }

            userDistributionChartInstance = new Chart(userCtx, {
                type: 'pie',
                data: {
                    labels: ['Students', 'Teachers', 'Admins'],
                    datasets: [{
                        data: [
                            overviewData.totalStudents,
                            overviewData.totalTeachers,
                            overviewData.totalAdmins || 1
                        ],
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((context.raw / total) * 100);
                                    return `${context.label}: ${context.raw} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Grade Distribution Chart
            const gradeCtx = document.getElementById('gradeDistributionChart').getContext('2d');

            // Destroy previous chart instance if it exists
            if (gradeDistributionChartInstance) {
                gradeDistributionChartInstance.destroy();
            }

            gradeDistributionChartInstance = new Chart(gradeCtx, {
                type: 'bar',
                data: {
                    labels: ['90-100', '80-89', '70-79', '60-69', '0-59'],
                    datasets: [{
                        label: 'Number of Grades',
                        data: [
                            gradesData.distribution['90-100'] || 0,
                            gradesData.distribution['80-89'] || 0,
                            gradesData.distribution['70-79'] || 0,
                            gradesData.distribution['60-69'] || 0,
                            gradesData.distribution['0-59'] || 0
                        ],
                        backgroundColor: '#4e73df'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Grades'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Grade Range'
                            }
                        }
                    }
                }
            });
        }

        // Function to refresh data
        function refreshData() {
            fetchData();
        }

        // Export functions
        function exportData(format) {
            // In a real application, this would fetch current data and export it
            alert(`Exporting data as ${format.toUpperCase()}...`);

            // For demonstration purposes, we'll just show an alert
            // You would implement actual export functionality here
        }

        // Initialize the dashboard when the page loads
        document.addEventListener('DOMContentLoaded', function () {
            fetchData();
        });
    </script>
</body>

</html>