<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %> - EdTech
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <% if (submissionType==='text' ) { %>
        <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
        <% } %>
</head>

<body>
    <%- include('../partials/navbar') %>

        <div class="container mt-4">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">
                                <i class="fas fa-upload me-2"></i>
                                Submit Assignment: <%= assignment.title %>
                            </h4>
                        </div>
                        <div class="card-body">
                            <% if (submissionType==='text' ) { %>
                                <!-- Rich Text Editor -->
                                <div id="textEditor">
                                    <div id="editor" style="height: 400px;"></div>
                                </div>
                                <% } else if (submissionType==='drawing' ) { %>
                                    <!-- Drawing Canvas -->
                                    <div id="drawingCanvas">
                                        <div class="toolbar mb-3">
                                            <button type="button" class="btn btn-outline-primary btn-sm" id="brushBtn">
                                                <i class="fas fa-paint-brush"></i> Brush
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                                id="eraserBtn">
                                                <i class="fas fa-eraser"></i> Eraser
                                            </button>
                                            <input type="color" id="colorPicker"
                                                class="form-control form-control-color d-inline-block w-auto">
                                            <input type="range" id="brushSize" class="form-range d-inline-block w-auto"
                                                min="1" max="50" value="5">
                                            <button type="button" class="btn btn-outline-danger btn-sm"
                                                id="clearCanvas">
                                                <i class="fas fa-trash"></i> Clear
                                            </button>
                                        </div>
                                        <canvas id="canvas" width="800" height="500"
                                            style="border: 1px solid #ccc; cursor: crosshair;"></canvas>
                                    </div>
                                    <% } %>

                                        <div class="mt-4">
                                            <button type="button" id="submitBtn" class="btn btn-success btn-lg">
                                                <i class="fas fa-paper-plane me-2"></i> Submit Assignment
                                            </button>
                                            <a href="/student/class/<%= assignment.class.id %>/assignments"
                                                class="btn btn-secondary btn-lg ms-2">
                                                <i class="fas fa-times me-2"></i> Cancel
                                            </a>
                                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <% if (submissionType==='text' ) { %>
            <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
            <% } %>

                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
                <script>
                    const assignmentId = <%= assignment.id %>;
                    const submissionType = '<%= submissionType %>';

                    document.addEventListener('DOMContentLoaded', function () {
                        if (submissionType === 'text') {
                            initializeTextEditor();
                        } else if (submissionType === 'drawing') {
                            initializeDrawingCanvas();
                        }

                        document.getElementById('submitBtn').addEventListener('click', submitAssignment);
                    });

                    function initializeTextEditor() {
                        const quill = new Quill('#editor', {
                            theme: 'snow',
                            modules: {
                                toolbar: [
                                    [{ 'header': [1, 2, 3, false] }],
                                    ['bold', 'italic', 'underline'],
                                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                    ['link', 'image'],
                                    ['clean']
                                ]
                            },
                            placeholder: 'Write your assignment here...'
                        });

                        window.quill = quill;
                    }

                    function initializeDrawingCanvas() {
                        const canvas = document.getElementById('canvas');
                        const ctx = canvas.getContext('2d');
                        let isDrawing = false;
                        let lastX = 0;
                        let lastY = 0;
                        let currentTool = 'brush';
                        let currentColor = '#000000';
                        let brushSize = 5;

                        // Set canvas background to white
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        // Tool buttons
                        document.getElementById('brushBtn').addEventListener('click', () => currentTool = 'brush');
                        document.getElementById('eraserBtn').addEventListener('click', () => currentTool = 'eraser');
                        document.getElementById('colorPicker').addEventListener('input', (e) => currentColor = e.target.value);
                        document.getElementById('brushSize').addEventListener('input', (e) => brushSize = e.target.value);
                        document.getElementById('clearCanvas').addEventListener('click', () => {
                            ctx.fillStyle = 'white';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                        });

                        // Drawing functions
                        canvas.addEventListener('mousedown', startDrawing);
                        canvas.addEventListener('mousemove', draw);
                        canvas.addEventListener('mouseup', stopDrawing);
                        canvas.addEventListener('mouseout', stopDrawing);

                        function startDrawing(e) {
                            isDrawing = true;
                            [lastX, lastY] = [e.offsetX, e.offsetY];
                        }

                        function draw(e) {
                            if (!isDrawing) return;

                            ctx.beginPath();
                            ctx.moveTo(lastX, lastY);
                            ctx.lineTo(e.offsetX, e.offsetY);

                            if (currentTool === 'brush') {
                                ctx.strokeStyle = currentColor;
                            } else if (currentTool === 'eraser') {
                                ctx.strokeStyle = 'white';
                            }

                            ctx.lineWidth = brushSize;
                            ctx.lineCap = 'round';
                            ctx.lineJoin = 'round';
                            ctx.stroke();

                            [lastX, lastY] = [e.offsetX, e.offsetY];
                        }

                        function stopDrawing() {
                            isDrawing = false;
                        }

                        window.canvas = canvas;
                    }

                    async function submitAssignment() {
                        let content = '';

                        if (submissionType === 'text') {
                            content = window.quill.root.innerHTML;
                        } else if (submissionType === 'drawing') {
                            content = window.canvas.toDataURL('image/png');
                        }

                        if (!content || (submissionType === 'text' && content === '<p><br></p>')) {
                            alert('Please provide your assignment content before submitting.');
                            return;
                        }

                        try {
                            const response = await fetch(`/student/assignments/${assignmentId}/submit-enhanced`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    content: content,
                                    type: submissionType
                                })
                            });

                            const result = await response.json();

                            if (result.success) {
                                alert('Assignment submitted successfully!');
                                window.location.href = `/student/class/<%= assignment.class.id %>/assignments`;
                            } else {
                                alert('Error: ' + result.message);
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('An error occurred while submitting the assignment.');
                        }
                    }
                </script>
</body>

</html>