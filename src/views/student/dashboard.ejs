<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdTech - Student Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .profile-section {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .profile-img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .welcome-text {
            font-size: 1.2rem;
            margin-top: 10px;
        }

        .user-role {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-block;
            margin-top: 5px;
        }

        .dashboard-card {
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            height: 100%;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            border-top-left-radius: 10px !important;
            border-top-right-radius: 10px !important;
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .action-btn {
            transition: all 0.3s ease;
            border-radius: 8px;
            text-align: left;
            padding: 12px 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .action-btn i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .action-btn:hover {
            transform: translateX(5px);
        }

        .avatar-img {
            object-fit: cover;
        }

        .stat-card {
            transition: all 0.3s ease;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .access-denied {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 50px 0;
        }

        .countdown-timer {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b6b;
            margin: 20px 0;
        }

        .payment-reminder {
            border-left: 5px solid #ffc107;
            animation: pulse 2s infinite;
        }

        .urgent-countdown {
            border-left: 5px solid #dc3545;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }

            100% {
                opacity: 1;
            }
        }

        .payment-banner {
            background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #ffc107;
        }
    </style>
</head>

<body>
    <%- include('../partials/navbar') %>

        <div class="container mt-4">
            <%- include('../partials/alerts') %>

                <!-- ACCESS CONTROL: Check if student can access dashboard -->
                <% const now=new Date(); %>
                    <% const hasAccess=student.tuitionStatus==='paid' || (student.tuitionStatus==='partial' &&
                        student.tempPasswordExpiry && new Date(student.tempPasswordExpiry)> now) %>

                        <% if (!hasAccess) { %>
                            <!-- ACCESS DENIED VIEW -->
                            <div class="access-denied">
                                <div class="row justify-content-center">
                                    <div class="col-md-8">
                                        <i class="fas fa-lock fa-5x mb-4"></i>
                                        <h2>Access Restricted</h2>
                                        <p class="lead">Your account access has been restricted due to unpaid tuition
                                            fees.</p>

                                        <div class="row mt-4">
                                            <div class="col-md-6">
                                                <div class="card text-white bg-danger">
                                                    <div class="card-body">
                                                        <h5>Current Status</h5>
                                                        <p class="mb-1">Tuition: <strong>
                                                                <%= student.tuitionStatus ?
                                                                    student.tuitionStatus.toUpperCase() : 'UNPAID' %>
                                                            </strong></p>
                                                        <% if (student.tempPasswordExpiry && new
                                                            Date(student.tempPasswordExpiry) < now) { %>
                                                            <p class="mb-0">Access expired on: <%= new
                                                                    Date(student.tempPasswordExpiry).toLocaleDateString()
                                                                    %>
                                                            </p>
                                                            <% } %>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card text-white bg-warning">
                                                    <div class="card-body">
                                                        <h5>Required Action</h5>
                                                        <p>Please contact the School Administration office to settle
                                                            your tuition fees and restore access to your account.</p>
                                                        <button class="btn btn-light" onclick="contactAdmin()">
                                                            <i class="fas fa-phone"></i> Contact Administration
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <% } else { %>
                                <!-- NORMAL DASHBOARD VIEW -->

                                <!-- Payment Reminder Banner for Partial Payment Students -->
                                <% if (student.tuitionStatus==='partial' && student.tempPasswordExpiry) { %>
                                    <% const expiryDate=new Date(student.tempPasswordExpiry); %>
                                        <% const daysRemaining=Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24)); %>

                                            <div class="payment-banner">
                                                <div class="row align-items-center">
                                                    <div class="col-md-8">
                                                        <h5 class="mb-1">
                                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                                            Payment Balance Required
                                                        </h5>
                                                        <p class="mb-0">
                                                            Your tuition payment is incomplete. Please settle the
                                                            remaining balance to maintain uninterrupted access to your
                                                            account.
                                                            <% if (daysRemaining <=5) { %>
                                                                <strong class="text-danger">Urgent: Only <%=
                                                                        daysRemaining %> day(s) remaining!</strong>
                                                                <% } else { %>
                                                                    You have <%= daysRemaining %> days remaining to
                                                                        complete your payment.
                                                                        <% } %>
                                                        </p>
                                                    </div>
                                                    <div class="col-md-4 text-end">
                                                        <button class="btn btn-warning btn-sm" onclick="contactAdmin()">
                                                            <i class="fas fa-money-bill-wave me-1"></i>
                                                            Pay Balance Now
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <% } %>

                                                <div class="row">
                                                    <!-- Left Sidebar with Profile -->
                                                    <div class="col-md-3">
                                                        <div class="profile-section text-center">
                                                            <% if (user.avatar) { %>
                                                                <img src="<%= user.avatar.startsWith('/') ? user.avatar : '/' + user.avatar %>"
                                                                    alt="Student Profile"
                                                                    class="profile-img mb-3 avatar-img"
                                                                    onerror="this.onerror=null; this.src='/images/default-profile.png'">
                                                                <% } else { %>
                                                                    <img src="/images/default-profile.png"
                                                                        alt="Student Profile" class="profile-img mb-3">
                                                                    <% } %>
                                                                        <h4>
                                                                            <%= user.firstName %>
                                                                                <%= user.lastName %>
                                                                        </h4>
                                                                        <p class="welcome-text">Welcome to your dashboard</p>
                                                                        <span class="user-role">
                                                                            Student
                                                                        </span>
                                                                        <!-- Add school info -->
                                                                        <div class="mt-2">
                                                                            <small><i class="fas fa-school me-1"></i>
                                                                                <%= userSchool %>
                                                                            </small>
                                                                        </div>
                                                                        </div>

                                                        <div class="card dashboard-card mb-4">
                                                            <div class="card-header">
                                                                <h5>Quick Actions</h5>
                                                            </div>
                                                            <div class="card-body">
                                                                <% if (student.canChangePassword) { %>
                                                                    <a href="/auth/change-password"
                                                                        class="btn btn-outline-primary w-100 mb-2 action-btn">
                                                                        <i class="fas fa-key"></i> Change Password
                                                                    </a>
                                                                    <% } %>
                                                                        <a href="/student/classes"
                                                                            class="btn btn-outline-secondary w-100 action-btn">
                                                                            <i class="fas fa-chalkboard"></i> View All
                                                                            Classes
                                                                        </a>
                                                            </div>
                                                        </div>

                                                        <!-- Account Status Card -->
                                                        <div class="card dashboard-card mb-4">
                                                            <div class="card-header">
                                                                <h5>Account Status</h5>
                                                            </div>
                                                            <div class="card-body">
                                                                <div class="mb-3">
                                                                    <strong>Tuition Status:</strong>
                                                                    <span class="badge bg-<%= 
                                    student.tuitionStatus === 'paid' ? 'success' : 
                                    student.tuitionStatus === 'partial' ? 'warning' : 'danger' 
                                %> ms-2">
                                                                        <%= student.tuitionStatus ?
                                                                            student.tuitionStatus.toUpperCase()
                                                                            : 'UNPAID' %>
                                                                    </span>
                                                                </div>
                                                                <div class="mb-3">
                                                                    <strong>Password:</strong>
                                                                    <% if (user.isTemporaryPassword) { %>
                                                                        <span class="badge bg-warning ms-2">Temporary
                                                                            Password</span>
                                                                        <% if (student.tempPasswordExpiry) { %>
                                                                            <br><small class="text-muted">Expires: <%=
                                                                                    new
                                                                                    Date(student.tempPasswordExpiry).toLocaleDateString()
                                                                                    %></small>
                                                                            <% } %>
                                                                                <% } else { %>
                                                                                    <span
                                                                                        class="badge bg-success ms-2">Permanent
                                                                                        Password</span>
                                                                                    <% } %>
                                                                </div>

                                                                <!-- Partial Payment Countdown -->
                                                                <% if (student.tuitionStatus==='partial' &&
                                                                    student.tempPasswordExpiry) { %>
                                                                    <% const expiryDate=new
                                                                        Date(student.tempPasswordExpiry); %>
                                                                        <% const daysRemaining=Math.ceil((expiryDate -
                                                                            now) / (1000 * 60 * 60 * 24)); %>

                                                                            <div
                                                                                class="alert <%= daysRemaining <= 5 ? 'alert-danger urgent-countdown' : 'alert-warning payment-reminder' %> mt-3">
                                                                                <i
                                                                                    class="fas <%= daysRemaining <= 5 ? 'fa-exclamation-circle' : 'fa-clock' %>"></i>
                                                                                <strong>
                                                                                    <%= daysRemaining <=5 ? 'URGENT: '
                                                                                        : 'Temporary Access' %>
                                                                                </strong><br>
                                                                                <% if (daysRemaining <=5) { %>
                                                                                    <div class="countdown-timer"
                                                                                        id="countdownTimer"></div>
                                                                                    <strong class="text-danger">Your
                                                                                        access will expire in <%=
                                                                                            daysRemaining %>
                                                                                            day(s)!</strong><br>
                                                                                    Complete your payment immediately to
                                                                                    avoid disruption.
                                                                                    <% } else { %>
                                                                                        Your access will expire in:
                                                                                        <div id="countdownTimer"
                                                                                            class="countdown-timer">
                                                                                        </div>
                                                                                        Complete your payment to
                                                                                        maintain access.
                                                                                        <% } %>
                                                                            </div>
                                                                            <% } %>

                                                                                <!-- Password Change Section -->
                                                                                <% if (student.canChangePassword) { %>
                                                                                    <hr>
                                                                                    <a href="/auth/change-password"
                                                                                        class="btn btn-outline-primary w-100 action-btn">
                                                                                        <i class="fas fa-key"></i>
                                                                                        Change Password
                                                                                    </a>
                                                                                    <% } else { %>
                                                                                        <div
                                                                                            class="alert alert-warning mt-3">
                                                                                            <i
                                                                                                class="fas fa-exclamation-triangle"></i>
                                                                                            You cannot change your
                                                                                            password until tuition is
                                                                                            fully paid.
                                                                                            Please contact
                                                                                            administration if you need a
                                                                                            password reset.
                                                                                        </div>
                                                                                        <% } %>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Main Content -->
                                                    <div class="col-md-9">
                                                        <!-- Additional Urgent Alert for 5 Days or Less -->
                                                        <% if (student.tuitionStatus==='partial' &&
                                                            student.tempPasswordExpiry) { %>
                                                            <% const expiryDate=new Date(student.tempPasswordExpiry); %>
                                                                <% const daysRemaining=Math.ceil((expiryDate - now) /
                                                                    (1000 * 60 * 60 * 24)); %>

                                                                    <% if (daysRemaining <=5) { %>
                                                                        <div
                                                                            class="alert alert-danger urgent-countdown mb-4">
                                                                            <div class="d-flex align-items-center">
                                                                                <i
                                                                                    class="fas fa-exclamation-triangle fa-2x me-3"></i>
                                                                                <div class="flex-grow-1">
                                                                                    <h5 class="alert-heading mb-2">
                                                                                        Payment Required Immediately!
                                                                                    </h5>
                                                                                    <p class="mb-2">
                                                                                        Your temporary access will
                                                                                        expire in <strong>
                                                                                            <%= daysRemaining %> day(s)
                                                                                        </strong>.
                                                                                        Complete your tuition payment
                                                                                        immediately to avoid losing
                                                                                        access to:
                                                                                    </p>
                                                                                    <ul class="mb-2">
                                                                                        <li>Class materials and
                                                                                            assignments</li>
                                                                                        <li>Exam schedules and results
                                                                                        </li>
                                                                                        <li>All learning resources</li>
                                                                                    </ul>
                                                                                    <button class="btn btn-danger"
                                                                                        onclick="contactAdmin()">
                                                                                        <i
                                                                                            class="fas fa-phone me-1"></i>
                                                                                        Contact Administration Now
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <% } %>
                                                                            <% } %>

                                                                                <!-- Statistics Cards Row -->
                                                                                <div class="row">
                                                                                    <div class="col-md-4 mb-4">
                                                                                        <div
                                                                                            class="card text-center stat-card">
                                                                                            <div class="card-body">
                                                                                                <h1 class="display-4">
                                                                                                    <strong>
                                                                                                        <%= enrollments
                                                                                                            ?
                                                                                                            enrollments.length
                                                                                                            : 0 %>
                                                                                                    </strong>
                                                                                                </h1>
                                                                                                <p class="card-text">
                                                                                                    <strong>Enrolled
                                                                                                        Classes</strong>
                                                                                                </p>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="col-md-4 mb-4">
                                                                                        <div
                                                                                            class="card text-center stat-card">
                                                                                            <div class="card-body">
                                                                                                <h1 class="display-4">
                                                                                                    <strong>
                                                                                                        <%= upcomingAssignments
                                                                                                            ?
                                                                                                            upcomingAssignments.length
                                                                                                            : 0 %>
                                                                                                    </strong>
                                                                                                </h1>
                                                                                                <p class="card-text">
                                                                                                    <strong>Upcoming
                                                                                                        Assignments</strong>
                                                                                                </p>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="col-md-4 mb-4">
                                                                                        <div
                                                                                            class="card text-center stat-card">
                                                                                            <div class="card-body">
                                                                                                <h1 class="display-4">
                                                                                                    <strong>
                                                                                                        <%= completedAssignments
                                                                                                            || 0 %>
                                                                                                    </strong>
                                                                                                </h1>
                                                                                                <p class="card-text">
                                                                                                    <strong>Completed
                                                                                                        Work</strong>
                                                                                                </p>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>

                                                                                <div class="row">
                                                                                    <div class="col-md-8">
                                                                                        <div
                                                                                            class="card mb-4 dashboard-card">
                                                                                            <div class="card-header">
                                                                                                <h4>My Classes</h4>
                                                                                            </div>
                                                                                            <div class="card-body">
                                                                                                <% if (enrollments &&
                                                                                                    enrollments.length>
                                                                                                    0) { %>
                                                                                                    <div class="row">
                                                                                                        <%
                                                                                                            enrollments.forEach(enrollment=>
                                                                                                            { %>
                                                                                                            <div
                                                                                                                class="col-md-6 mb-3">
                                                                                                                <div
                                                                                                                    class="card">
                                                                                                                    <div
                                                                                                                        class="card-body">
                                                                                                                        <h5
                                                                                                                            class="card-title">
                                                                                                                            <%= enrollment.class.name
                                                                                                                                %>
                                                                                                                        </h5>
                                                                                                                        <p
                                                                                                                            class="card-text">
                                                                                                                            Grade/Class:
                                                                                                                            <%= enrollment.class.grade
                                                                                                                                %>
                                                                                                                                -
                                                                                                                                <%= enrollment.class.section
                                                                                                                                    %>
                                                                                                                                    <br>
                                                                                                                                    Teacher:
                                                                                                                                    <%= enrollment.class.teacher.user.firstName
                                                                                                                                        %>
                                                                                                                                        <%= enrollment.class.teacher.user.lastName
                                                                                                                                            %>
                                                                                                                        </p>
                                                                                                                        <a href="/student/class/<%= enrollment.class.id %>/materials"
                                                                                                                            class="btn btn-sm btn-outline-primary">Materials</a>
                                                                                                                        <a href="/student/class/<%= enrollment.class.id %>/assignments"
                                                                                                                            class="btn btn-sm btn-outline-primary">Assignments</a>
                                                                                                                        <a href="/student/class/<%= enrollment.class.id %>/exams"
                                                                                                                            class="btn btn-sm btn-outline-primary">Exams</a>
                                                                                                                    </div>
                                                                                                                </div>
                                                                                                            </div>
                                                                                                            <% }); %>
                                                                                                    </div>
                                                                                                    <% } else { %>
                                                                                                        <p>You are not
                                                                                                            enrolled in
                                                                                                            any classes
                                                                                                            yet.</p>
                                                                                                        <% } %>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>

                                                                                    <div class="col-md-4">
                                                                                        <div
                                                                                            class="card dashboard-card">
                                                                                            <div class="card-header">
                                                                                                <h4>Upcoming Assignments
                                                                                                </h4>
                                                                                            </div>
                                                                                            <div class="card-body">
                                                                                                <% if
                                                                                                    (upcomingAssignments
                                                                                                    &&
                                                                                                    upcomingAssignments.length>
                                                                                                    0) { %>
                                                                                                    <%
                                                                                                        upcomingAssignments.forEach(assignment=>
                                                                                                        { %>
                                                                                                        <div
                                                                                                            class="mb-3 p-2 border rounded">
                                                                                                            <h6>
                                                                                                                <%= assignment.title
                                                                                                                    %>
                                                                                                            </h6>
                                                                                                            <small
                                                                                                                class="text-muted">
                                                                                                                Class:
                                                                                                                <%= assignment.class.name
                                                                                                                    %>
                                                                                                                    <br>
                                                                                                                    Due:
                                                                                                                    <%= new
                                                                                                                        Date(assignment.dueDate).toLocaleDateString()
                                                                                                                        %>
                                                                                                            </small>
                                                                                                        </div>
                                                                                                        <% }); %>
                                                                                                            <% } else {
                                                                                                                %>
                                                                                                                <p>No
                                                                                                                    upcoming
                                                                                                                    assignments.
                                                                                                                </p>
                                                                                                                <% } %>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                    </div>
                                                </div>
                                                <% } %>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
        // Countdown timer for partial payment expiry
        <% if (student.tuitionStatus === 'partial' && student.tempPasswordExpiry) { %>
                function updateCountdown() {
                    const expiryDate = new Date('<%= student.tempPasswordExpiry %>');
                    const now = new Date();
                    const diff = expiryDate - now;

                    if (diff <= 0) {
                        const countdownElements = document.querySelectorAll('#countdownTimer');
                        countdownElements.forEach(element => {
                            element.innerHTML = 'ACCESS EXPIRED';
                        });
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                        return;
                    }

                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                    const countdownText = `${days}d ${hours}h ${minutes}m ${seconds}s`;

                    // Update all countdown elements
                    const countdownElements = document.querySelectorAll('#countdownTimer');
                    countdownElements.forEach(element => {
                        element.innerHTML = countdownText;
                    });
                }

                // Update countdown every second
                setInterval(updateCountdown, 1000);
                updateCountdown(); // Initial call
        <% } %>

                function contactAdmin() {
                    alert('Please contact the School Administration office:\n\n' +
                        ' Phone: +1234567890\n' +
                        ' Email: admin@edutech.school\n' +
                        ' Office: Room 101, Administration Building\n' +
                        ' Hours: Monday-Friday, 8:00 AM - 4:00 PM\n\n' +
                        'Please have your student ID and payment details ready.');

                    // Optional: Open email client
                    // window.location.href = 'mailto:admin@edutech.com?subject=Tuition Payment Inquiry&body=Dear Administration, I would like to inquire about my tuition payment. My student ID is: <%= user.idNumber %>';
                }

            // Auto-logout check for expired access
            function checkAccessStatus() {
                fetch('/student/check-access')
                    .then(response => response.json())
                    .then(data => {
                        if (!data.hasAccess) {
                            window.location.reload();
                        }
                    })
                    .catch(error => console.error('Error checking access:', error));
            }

            // Check access every 5 minutes
            setInterval(checkAccessStatus, 300000);

        // Show payment reminder modal on page load for partial payment students
        <% if (student.tuitionStatus === 'partial' && student.tempPasswordExpiry) { %>
            <% const expiryDate = new Date(student.tempPasswordExpiry); %>
            <% const daysRemaining = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24)); %>
            
            <% if (daysRemaining <= 3) { %>
                    document.addEventListener('DOMContentLoaded', function () {
                        setTimeout(() => {
                            if (confirm(' URGENT PAYMENT REMINDER\n\nYour access will expire in ' + <%= daysRemaining %> + ' days.\n\nDo you want to contact administration now to complete your payment?')) {
                                contactAdmin();
                            }
                        }, 2000);
                    });
            <% } %>
        <% } %>
        </script>
</body>

</html>