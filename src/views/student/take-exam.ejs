<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .exam-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
        }

        .question-card {
            border-left: 4px solid #667eea;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .question-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .option-label {
            cursor: pointer;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .option-label:hover {
            background-color: #f8f9fa;
        }

        .option-label.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }

        .navigation-buttons {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 15px 0;
            border-top: 1px solid #dee2e6;
        }
    </style>
</head>

<body>
    <%- include('../partials/navbar') %>

        <div class="container mt-4">
            <div class="exam-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2>
                            <%= exam.title %>
                        </h2>
                        <p class="mb-0">
                            <%= exam.description %>
                        </p>
                        <small>Class: <%= exam.class.name %> | Teacher: <%= exam.teacher.user.firstName %>
                                    <%= exam.teacher.user.lastName %></small>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="timer" id="timer">
                            Time Left: <span id="time-display"></span>
                        </div>
                    </div>
                </div>
            </div>

            <form id="examForm">
                <input type="hidden" name="examId" value="<%= exam.id %>">
                <input type="hidden" name="attemptId" value="<%= attempt.id %>">
                <input type="hidden" name="timeSpent" id="timeSpent" value="0">

                <div id="questions-container">
                    <% if (questions && questions.length> 0) { %>
                        <% questions.forEach((question, index)=> { %>
                            <div class="card question-card" id="question-<%= index %>">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        Question <%= index + 1 %>
                                            <% if (question.marks) { %>
                                                <span class="badge bg-primary float-end">
                                                    <%= question.marks %> marks
                                                </span>
                                                <% } %>
                                    </h5>
                                    <p class="card-text">
                                        <%= question.question %>
                                    </p>
                
                                    <% if (question.type==='multiple_choice' ) { %>
                                        <div class="options">
                                            <% question.options.forEach((option, optIndex)=> { %>
                                                <div class="option-label" onclick="selectOption(this, <%= index %>, '<%= optIndex %>')">
                                                    <input type="radio" name="answers[<%= index %>]" value="<%= optIndex %>"
                                                        id="q<%= index %>_opt<%= optIndex %>" style="display: none;">
                                                    <label for="q<%= index %>_opt<%= optIndex %>" class="mb-0 w-100">
                                                        <%= String.fromCharCode(65 + optIndex) %>. <%= option %>
                                                    </label>
                                                </div>
                                                <% }); %>
                                        </div>
                                        <% } else if (question.type==='true_false' ) { %>
                                            <div class="options">
                                                <div class="option-label" onclick="selectOption(this, <%= index %>, 'true')">
                                                    <input type="radio" name="answers[<%= index %>]" value="true"
                                                        id="q<%= index %>_true" style="display: none;">
                                                    <label for="q<%= index %>_true" class="mb-0 w-100">True</label>
                                                </div>
                                                <div class="option-label" onclick="selectOption(this, <%= index %>, 'false')">
                                                    <input type="radio" name="answers[<%= index %>]" value="false"
                                                        id="q<%= index %>_false" style="display: none;">
                                                    <label for="q<%= index %>_false" class="mb-0 w-100">False</label>
                                                </div>
                                            </div>
                                            <% } else if (question.type==='short_answer' ) { %>
                                                <div class="form-group">
                                                    <textarea class="form-control" name="answers[<%= index %>]" rows="3"
                                                        placeholder="Type your answer here..."
                                                        oninput="saveAnswer(<%= index %>, this.value)"></textarea>
                                                </div>
                                                <% } %>
                                </div>
                            </div>
                            <% }); %>
                                <% } else { %>
                                    <div class="alert alert-warning text-center">
                                        <h4>No questions available for this exam</h4>
                                        <p>Please contact your teacher.</p>
                                    </div>
                                    <% } %>
                </div>
                
                <div class="navigation-buttons">
                    <div class="row">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-secondary" onclick="saveProgress()">
                                <i class="fas fa-save"></i> Save Progress
                            </button>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" class="btn btn-success" onclick="submitExam()">
                                <i class="fas fa-paper-plane"></i> Submit Exam
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal fade" id="submitModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Submit Exam</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to submit your exam? This action cannot be undone.</p>
                        <p class="text-muted">Time spent: <span id="modal-time-spent"></span></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="confirmSubmit()">Submit Exam</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            let startTime = new Date().getTime();
            let examDuration = <%= exam.duration %> * 60 * 1000; // Convert to milliseconds
            let timeLeft = examDuration;
            let timerInterval;

            // Timer functionality
            function startTimer() {
                timerInterval = setInterval(updateTimer, 1000);
            }

            function updateTimer() {
                timeLeft -= 1000;
                const timeSpent = Math.floor((new Date().getTime() - startTime) / 1000);
                document.getElementById('timeSpent').value = timeSpent;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitExam();
                    return;
                }

                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                document.getElementById('time-display').textContent =
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            function selectOption(element, questionIndex, value) {
                // Remove selected class from all options in this question
                const questionElement = document.getElementById(`question-${questionIndex}`);
                questionElement.querySelectorAll('.option-label').forEach(opt => {
                    opt.classList.remove('selected');
                });

                // Add selected class to clicked option
                element.classList.add('selected');

                // Check the radio button
                const radio = element.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                }

                saveProgress();
            }

            function saveAnswer(questionIndex, value) {
                saveProgress();
            }

            function saveProgress() {
                const formData = new FormData(document.getElementById('examForm'));
                const answers = {};

                // Collect all answers
                formData.forEach((value, key) => {
                    if (key.startsWith('answers[')) {
                        const match = key.match(/answers\[(\d+)\]/);
                        if (match) {
                            answers[match[1]] = value;
                        }
                    }
                });

                // Save to localStorage as backup
                localStorage.setItem(`exam_<%= exam.id %>_answers`, JSON.stringify(answers));

                // Auto-save to server (optional - you can implement this)
                console.log('Progress saved locally', answers);
            }

            function loadProgress() {
                    const saved = localStorage.getItem(`exam_<%= exam.id %>_answers`);
                    if (saved) {
                        const answers = JSON.parse(saved);
                        Object.keys(answers).forEach(questionIndex => {
                            const value = answers[questionIndex];
                            const input = document.querySelector(`[name="answers[${questionIndex}]"]`);
                            if (input) {
                                if (input.type === 'radio') {
                                    const radio = document.querySelector(`[name="answers[${questionIndex}]"][value="${value}"]`);
                                    if (radio) {
                                        radio.checked = true;
                                        radio.parentElement.classList.add('selected');
                                    }
                                } else if (input.type === 'textarea' || input.type === 'text') {
                                    input.value = value;
                                }
                            }
                        });
                    }
                } 

            function submitExam() {
                const timeSpent = document.getElementById('timeSpent').value;
                document.getElementById('modal-time-spent').textContent =
                    `${Math.floor(timeSpent / 60)} minutes ${timeSpent % 60} seconds`;

                const modal = new bootstrap.Modal(document.getElementById('submitModal'));
                modal.show();
            }

            function confirmSubmit() {
                clearInterval(timerInterval);

                const formData = new FormData(document.getElementById('examForm'));
                const answers = {};

                formData.forEach((value, key) => {
                    if (key.startsWith('answers[')) {
                        const match = key.match(/answers\[(\d+)\]/);
                        if (match) {
                            answers[match[1]] = value;
                        }
                    }
                });

                fetch(`/student/api/exams/<%= exam.id %>/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        answers: answers,
                        timeSpent: document.getElementById('timeSpent').value
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Clear local storage
                            localStorage.removeItem(`exam_<%= exam.id %>_answers`);

                            // Redirect to results page
                            window.location.href = `/student/exams/${data.attemptId}/results`;
                        } else {
                            alert('Error submitting exam: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error submitting exam. Please try again.');
                    });
            }

            // Initialize
            document.addEventListener('DOMContentLoaded', function () {
                startTimer();
                loadProgress();
            });
        </script>
</body>

</html>